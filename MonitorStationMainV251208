import pymysql.cursors
from datetime import datetime
from DB import DatabaseConnector
import time
import tkinter as tk
from tkinter import scrolledtext
from gpiozero import LED, Button
from gpiozero.exc import GPIOPinInUse
from threading import Thread
import numpy as np
import requests
import json

# --- Theme Colors ---
BG_MAIN = "#181818"        # Deep blackish background
BG_FRAME = "#232323"       # Dark grey for frames
BG_INDICATOR = "#333333"   # Slightly lighter grey for indicators
FG_TEXT = "#E0E0E0"        # Light grey for text
FG_LABEL = "#B0B0B0"       # Soft grey for labels
GREEN_ON = "#43FF43"       # Neon green for ON
RED_ON = "#FF4242"         # Bright red for alarms
BRIGHT_BLUE = "#1EC8FF"    # Bright blue for canvas border/accent
GREY_OFF = "#5A5A5A"       # Medium grey for OFF
WHITE = "#FFFFFF"

class MachineStatusApp2:
    def __init__(self, root):
        self.temp = 0
        self.db = None
        self.gui = None
        self.rodi_power_on_temp = 0
        self.rodi_alarm_status_temp = 0
        self.lift_power_on_temp = 0
        self.lift_alarm_status_temp = 0
        self.connected = False
        
        self.dt = None
        

        self.time_last = 0
        self.timer_on = False

        self.alarm_power_rodi = False
        self.alarm_rodi = False
        self.alarm_power_lift = False
        self.alarm_lift = False
        
        self.alarm_buzzer = False

        self.send_message_trigger = True
       
        self.input_signal = {
            25: False,
        }
        self.input_temp_signal = {
            25: tk.BooleanVar()
        }
        self.output_signal = {
            27: False,
            22: False,
            13: False,
            19: False,
            26: False,
        }
        self.output_temp_signal = {
            27: tk.BooleanVar(),
            22: tk.BooleanVar(),
            13: tk.BooleanVar(),
            19: tk.BooleanVar(),
            26: tk.BooleanVar()
        }
        
        self.tk_Connection_status = tk.StringVar()

        self.thread = Thread(target=self.RunMain)
        self.thread.daemon = True
        self.thread.start()

        self.root = root
        self.root.configure(bg=BG_MAIN)
        self.root.title("Connection Status GUI")

        # Connection Status
        self.connection_status_label = tk.Label(root, text="Connection Status:", font=("Arial", 12), bg=BG_MAIN, fg=FG_LABEL)
        self.connection_status_label.grid(row=0, column=0, padx=10, pady=5, sticky="w")
        self.connection_status_value = tk.Label(root, text="Disconnected", font=("Arial", 12), bg=BG_MAIN, fg=RED_ON)
        self.connection_status_value.grid(row=0, column=1, padx=10, pady=5, sticky="w")

        # Log Section
        self.log_label = tk.Label(root, text="Log:", font=("Arial", 12), bg=BG_MAIN, fg=FG_LABEL)
        self.log_label.grid(row=1, column=0, padx=10, pady=5, sticky="w")
        self.log_text = scrolledtext.ScrolledText(root, width=100, height=10, font=("Arial", 10), bg=BG_FRAME, fg=FG_TEXT, insertbackground=WHITE, borderwidth=2, highlightbackground=BRIGHT_BLUE, highlightcolor=BRIGHT_BLUE)
        self.log_text.grid(row=2, column=0, columnspan=2, padx=10, pady=5)

        # Machine Status Frames
        self.machine_status_frame = tk.Frame(root, bg=BG_MAIN)
        self.machine_status_frame.grid(row=3, column=0, columnspan=2, padx=10, pady=5)


        # RODI Status Interface
        self.rodi_status_frame = tk.LabelFrame(self.machine_status_frame, text="Hot RODI System Status", font=("Arial", 12),
                                               bg=BG_MAIN, fg=FG_LABEL, bd=2, relief=tk.GROOVE, highlightbackground=BG_MAIN, highlightcolor=BG_MAIN, highlightthickness=2)
        self.rodi_status_frame.grid(row=0, column=0, padx=10, pady=5, sticky="w")
        self.rodi_power_indicator = tk.Canvas(self.rodi_status_frame, width=30, height=30, bg=BG_MAIN, highlightthickness=2, highlightbackground=BG_MAIN)
        self.rodi_power_indicator.grid(row=0, column=0, padx=5)
        self.rodi_power_circle = self.rodi_power_indicator.create_oval(5, 5, 25, 25, fill=GREY_OFF, outline=GREY_OFF, width=2)
        tk.Label(self.rodi_status_frame, text="Power Supply", font=("Arial", 10), bg=BG_MAIN, fg=FG_LABEL).grid(row=0, column=1, padx=5)
        self.rodi_alarm_indicator = tk.Canvas(self.rodi_status_frame, width=30, height=30, bg=BG_MAIN, highlightthickness=2, highlightbackground=BG_MAIN)
        self.rodi_alarm_indicator.grid(row=0, column=2, padx=5)
        self.rodi_alarm_circle = self.rodi_alarm_indicator.create_oval(5, 5, 25, 25, fill=GREY_OFF, outline=GREY_OFF, width=2)
        tk.Label(self.rodi_status_frame, text="Alarm", font=("Arial", 10), bg=BG_MAIN, fg=FG_LABEL).grid(row=0, column=3, padx=5)

        # Lifting Tank Status Interface
        self.lift_status_frame = tk.LabelFrame(self.machine_status_frame, text="Lifting Tank System Status", font=("Arial", 12),
                                               bg=BG_MAIN, fg=FG_LABEL, bd=2, relief=tk.GROOVE, highlightbackground=BG_MAIN, highlightcolor=BG_MAIN, highlightthickness=2)
        self.lift_status_frame.grid(row=0, column=1, padx=10, pady=5, sticky="w")
        self.lift_power_indicator = tk.Canvas(self.lift_status_frame, width=30, height=30, bg=BG_MAIN, highlightthickness=2, highlightbackground=BG_MAIN)
        self.lift_power_indicator.grid(row=0, column=0, padx=5)
        self.lift_power_circle = self.lift_power_indicator.create_oval(5, 5, 25, 25, fill=GREY_OFF, outline=GREY_OFF, width=2)
        tk.Label(self.lift_status_frame, text="Power Supply", font=("Arial", 10), bg=BG_MAIN, fg=FG_LABEL).grid(row=0, column=1, padx=5)
        self.lift_alarm_indicator = tk.Canvas(self.lift_status_frame, width=30, height=30, bg=BG_MAIN, highlightthickness=2, highlightbackground=BG_MAIN)
        self.lift_alarm_indicator.grid(row=0, column=2, padx=5)
        self.lift_alarm_circle = self.lift_alarm_indicator.create_oval(5, 5, 25, 25, fill=GREY_OFF, outline=GREY_OFF, width=2)
        tk.Label(self.lift_status_frame, text="Alarm", font=("Arial", 10), bg=BG_MAIN, fg=FG_LABEL).grid(row=0, column=3, padx=5)

        # For Alarm Blinking
        self.alarm_blink_state = {"rodi": False, "lift": False}
        self.blink_interval = 500  # ms
        
        self.RODI_POWER_LED = LED(27)
        self.RODI_ALARM_LED = LED(22)
        
        self.LIFT_POWER_LED = LED(13)
        self.LIFT_ALARM_LED = LED(19)
        
        self.ALARM_BUZZER = LED(26)
        
        self.RODI_POWER_LED.off()
        self.RODI_ALARM_LED.off()
        
        self.LIFT_POWER_LED.off()
        self.LIFT_ALARM_LED.off()
        
        self.ALARM_BUZZER.off()
        
        self.RESET_BUZZER = Button(25)
        
    def connect(self):
        ip_addresses = ['169.254.41.32','169.254.41.33','169.254.41.34']
        for ip in ip_addresses:
            try:
                print(f"Attempting to connect to database at {ip}...")
                self.add_log_entry(f"Attempting to connect to database at {ip}...")
                self.db = DatabaseConnector(ip, 'root', 'IOtSt4ckToorMariaDb', 'sensor_data')
                self.db.connect()
                if self.db.check_is_connected():
                    print(f"Successfully connected to database at {ip}")
                    self.add_log_entry(f"Successfully connected to database at {ip}")
                    return self.db.connection
            except Exception as e:
                print(f"Failed to connect to database at {ip}: {e}")
                self.add_log_entry(f"Failed to connect to database at {ip}: {e}")
        print("All connection attempts failed.")
        return None

    def is_connected(self):
        if self.db and self.db.check_is_connected():
            return True
        else:
            return False

    def dis(self):
        if self.db:
            self.db.disconnect()

    def create_gpio_circle(self, name, pin, x, y):
        # Use blue outline for all circles
        circle = self.gpio_canvas.create_oval(x, y, x + 14, y + 14, fill=GREY_OFF, outline=GREY_OFF, width=2)
        self.gpio_circles[pin] = circle
        self.gpio_canvas.create_text(20, y + 7, text=f"{name}", font=("Arial", 10), anchor="w", fill=FG_LABEL)
        self.gpio_canvas.create_text(x + 30, y + 7, text=f"| Pin: {pin}", font=("Arial", 10), anchor="w", fill=FG_LABEL)

    def update_gpio_status(self, pin, status):
        # Power pins: green when ON, grey when OFF. Alarm pins: bright blue when ON, grey when OFF.
        power_pins = [27, 13]
        alarm_pins = [22, 19]
        if pin in power_pins:
            color = GREEN_ON if status else GREY_OFF
        else:
            color = GREEN_ON if status else GREY_OFF
        self.gpio_canvas.itemconfig(self.gpio_circles[pin], fill=color,outline=color)
        # self.add_log_entry(f"Pin {pin} : {status}")

    def update_connection_status(self, status):
        self.tk_Connection_status.set(status)
        fg_color = GREEN_ON if status == "Connected" else RED_ON
        self.connection_status_value.config(text=status, fg=fg_color)

    def add_log_entry(self, message):
        self.log_text.insert(tk.END, message + "\n")
        self.log_text.see(tk.END)
    def send_temas_message(self,message:str):
        try:
            webhook = "https://default086819dbed404544bfd2412c6f1af6.03.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/c1ea559f7ce64298b5a5e6629f046fce/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=-oU0in4wgL6lD-vBCvAWY0vBGDCnefLFHkqxhsRFArY"
            payload = {
                "message": message
                }
            headers = {
                "Content-Type": "application/json"
                }
            response = requests.post(webhook,headers=headers, data =json.dumps(payload))
        except Exception as e:
                self.add_log_entry(f"Failed to connect to Send Message, Please Check Internet Connection")
        return None

    def Timer(self, trigger, timer_time):    
        if trigger:
            if not self.timer_on:               
                self.time_last = time.time() + timer_time
                self.timer_on = True
            else:
                time_elapsed = int(self.time_last - time.time())
                if time.time() >= self.time_last:
                    self.timer_on = False
                    return True
            return False
        else:
            return False
        
    def update_machine_status(self):
        # Lifting Tank Power on Status
        
        self.lift_power_on_temp = self.db.get_machine_alarm_status(3)        
        
        if self.lift_power_on_temp == 1 :
            if self.alarm_power_lift:
                self.LIFT_POWER_LED.off()
                self.lift_power_indicator.itemconfig(self.lift_power_circle, fill=RED_ON , outline=RED_ON)
                self.add_log_entry(f"[{self.dt}] : LIFTING TANK Power Status: NO POWER!")
                #send notification to teams
                message = (
                    f"[_______ Status Update : Hot RODI & Lifting Tank Monitoring System _______] "
                    f"[{self.dt}] :  LIFTING TANK Power Status: NO POWER!")
                self.send_temas_message(message)
                self.alarm_power_lift = False
                
        elif self.lift_power_on_temp == 0 :
            if not self.alarm_power_lift:
                self.LIFT_POWER_LED.on()
                self.lift_power_indicator.itemconfig(self.lift_power_circle, fill=GREEN_ON, outline=GREEN_ON)
                self.add_log_entry(f"[{self.dt}] : LIFTING TANK Power Status: POWER RESTORED!")
                #send notification to teams
                message = (
                    f"[_______ Status Update : Hot RODI & Lifting Tank Monitoring System _______] "
                    f"[{self.dt}] :  LIFTING TANK Power Status: POWER RESTORED!")
                self.send_temas_message(message)
                self.alarm_power_lift = True
        # Lifting Tank Power on Status

                
        #Lifting Tank Alarm Status
        self.lift_alarm_status_temp = self.db.get_machine_alarm_status(4)
        
        if self.lift_alarm_status_temp == 1 or self.lift_power_on_temp == 1:
            if self.alarm_lift:
                self.LIFT_ALARM_LED.on()
                self.lift_alarm_indicator.itemconfig(self.lift_alarm_circle, fill=RED_ON  ,outline=RED_ON )
                self.add_log_entry(f"[{self.dt}] : LIFTING TANK Alarm Status: ALARM ACTIVE!")
                #send notification to teams
                message = (
                    f"[_______ Status Update : Hot RODI & Lifting Tank Monitoring System _______] "
                    f"[{self.dt}] : LIFTING TANK Alarm Status: ALARM ACTIVE!")
                self.send_temas_message(message)
                self.alarm_lift = False

            
        elif self.lift_alarm_status_temp == 0 and self.lift_power_on_temp == 0:
            if not self.alarm_lift:
                self.LIFT_ALARM_LED.off()
                self.lift_alarm_indicator.itemconfig(self.lift_alarm_circle, fill=GREY_OFF,outline=GREY_OFF)
                self.add_log_entry(f"[{self.dt}] : LIFTING TANK Alarm Status: ALARM CLEARED!")
                #send notification to teams
                message = (
                    f"[_______ Status Update : Hot RODI & Lifting Tank Monitoring System _______] "
                    f"[{self.dt}] : LIFTING TANK Alarm Status: ALARM CLEARED!")
                self.send_temas_message(message)
                self.alarm_lift = True
        #Lifting Tank Alarm Status

           
        #Hot RODI Power On Status
        self.rodi_power_on_temp = self.db.get_machine_alarm_status(1)
        
        if self.rodi_power_on_temp == 1 :        
            if self.alarm_power_rodi:
                self.RODI_POWER_LED.off()
                self.rodi_power_indicator.itemconfig(self.rodi_power_circle, fill=RED_ON , outline=RED_ON)
                self.add_log_entry(f"[{self.dt}] : Hot RODI Power Status: NO POWER!")
                #send notification to teams
                message = (
                    f"[_______ Status Update : Hot RODI & Lifting Tank Monitoring System _______] "
                    f"[{self.dt}] : Hot RODI Power Status: NO POWER!")
                self.send_temas_message(message)
                self.alarm_power_rodi = False
                    
        elif self.rodi_power_on_temp == 0 :
            if not self.alarm_power_rodi:
                self.RODI_POWER_LED.on()
                self.rodi_power_indicator.itemconfig(self.rodi_power_circle, fill=GREEN_ON, outline=GREEN_ON)
                self.add_log_entry(f"[{self.dt}] : Hot RODI Power Status: POWER RESTORED!")
                #send notification to teams
                message = (
                    f"[_______ Status Update : Hot RODI & Lifting Tank Monitoring System _______] "
                    f"[{self.dt}] : Hot RODI Power Status: POWER RESTORED!")
                self.send_temas_message(message)
                self.alarm_power_rodi = True
        #Hot RODI Power On Status

        # Hot RODI Alarm Status
        self.rodi_alarm_status_temp = self.db.get_machine_alarm_status(2)
        
        if self.rodi_alarm_status_temp == 1 or self.rodi_power_on_temp == 1:
            if self.alarm_rodi:
                self.RODI_ALARM_LED.on()
                self.rodi_alarm_indicator.itemconfig(self.rodi_alarm_circle, fill=RED_ON  ,outline=RED_ON )
                self.add_log_entry(f"[{self.dt}] : Hot RODI Alarm Status: ALARM ACTIVE!")
                #send notification to teams
                message = (
                    f"[_______ Status Update : Hot RODI & Lifting Tank Monitoring System _______] "
                    f"[{self.dt}] : Hot RODI Alarm Status: ALARM ACTIVE!")
                self.send_temas_message(message)
                self.alarm_rodi = False
            
        elif self.rodi_alarm_status_temp == 0 and self.rodi_power_on_temp == 0:
            if not self.alarm_rodi:
                self.RODI_ALARM_LED.off()
                self.rodi_alarm_indicator.itemconfig(self.rodi_alarm_circle, fill=GREY_OFF,outline=GREY_OFF)
                self.add_log_entry(f"[{self.dt}] : Hot RODI Alarm Status: ALARM CLEARED!")
                #send notification to teams
                message = (
                    f"[_______ Status Update : Hot RODI & Lifting Tank Monitoring System _______] "
                    f"[{self.dt}] : Hot RODI Alarm Status: ALARM CLEARED!")
                self.send_temas_message(message)
                self.alarm_rodi = True
        # Hot RODI Alarm Status

    def Send_message_by_hour(self, trigger):
        list_time = [0,6,11,12,18] 
        current_hour = datetime.now().hour
        if current_hour in list_time and trigger:
            message = (
            f"[_______ Status Update : Hot RODI & Lifting Tank Monitoring System _______] "
            f"{self.dt} :"
            f"[1] - Connection Status: {self.tk_Connection_status.get()} "
            f"[2] - RODI Power Status: {'POWER ON' if self.alarm_power_rodi else 'NO POWER'} "
            f"[3] - RODI Alarm Status: {'NO ALARM' if self.alarm_rodi else 'ALARM ACTIVE'} "
            f"[4] - Lifting Tank Power Status: {'POWER ON' if self.alarm_power_lift else 'NO POWER'} "
            f"[5] - Lifting Tank Alarm Status: {'NO ALARM' if self.alarm_lift else 'ALARM ACTIVE'}")
            self.send_temas_message(message)
            trigger = False
        elif current_hour not in list_time:
            trigger = True
        return trigger

    def RunMain(self):
        try:     
            while True:
                
                self.dt = datetime.now()
                self.dt = self.dt.replace( microsecond=0)
                if self.connected:
                    if self.Timer(True, 9):
                        if self.is_connected():
                            self.update_connection_status("Connected")

                        else:
                            self.update_connection_status("Disconnected")
                            self.add_log_entry(f"{self.dt} : Database disconnected. Retrying connection...")
                            self.connected = False

                    self.update_machine_status()
                    self.Send_message_by_hour(self.send_message_trigger)
                    
                    # Alarm Buzzer Control
                    # IF any alarm active and no power, turn on buzzer
                    if (not self.alarm_lift or not self.alarm_rodi or not self.alarm_power_lift or not self.alarm_power_rodi ) and not self.alarm_buzzer:
                        self.ALARM_BUZZER.on()
                        self.alarm_buzzer = True
                    # IF alarm cleared auto reset buzzer
                    elif (self.alarm_lift and self.alarm_rodi and self.alarm_power_lift and self.alarm_power_rodi ):
                        self.alarm_buzzer = False
                        self.ALARM_BUZZER.off()
                    
                    if self.RESET_BUZZER.is_pressed:
                        self.ALARM_BUZZER.off()
                   
                else:
                    self.update_connection_status("Disconnected")
                    self.add_log_entry(f"{self.dt} : Not connected to the database. Waiting for connection...")
                    if self.connect():
                        print('a')
                        self.update_connection_status("Connected")
                        self.add_log_entry(f"{self.dt} : Database connection established.")
                        self.connected = True
                    else:
                        print("Failed to connect to the database. Retrying in 5 seconds...")
                        self.update_connection_status("Disconnected")
                        self.add_log_entry("Failed to connect to the database. Retrying in 5 seconds...")
                        time.sleep(5)

        except KeyboardInterrupt:
            print("\nProgram interrupted by user. Exiting...")
            self.add_log_entry("Program interrupted by user. Exiting...")
            self.dis()
            self.update_connection_status("Disconnected")
            self.add_log_entry("Database disconnected.")

root = tk.Tk()
app = MachineStatusApp2(root)
root.mainloop()
